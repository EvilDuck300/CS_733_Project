<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Slides - Critic in the Loop</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .review-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .versions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .version-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: white;
            transition: all 0.3s;
        }
        .version-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .version-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .version-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .scores {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .score-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .score-clarity { background: #dbeafe; color: #1e40af; }
        .score-accuracy { background: #dcfce7; color: #166534; }
        .score-visual { background: #fef3c7; color: #92400e; }
        .score-audience { background: #e9d5ff; color: #6b21a8; }
        .overall-score {
            font-size: 32px;
            font-weight: bold;
            color: #10b981;
            text-align: center;
            margin: 15px 0;
        }
        .slides-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            background: #f9fafb;
            margin: 15px 0;
        }
        .slide-item {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #667eea;
        }
        .slide-title {
            font-weight: bold;
            font-size: 18px;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .slide-content {
            color: #4b5563;
            line-height: 1.6;
        }
        .slide-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .slide-content li {
            margin: 5px 0;
        }
        .feedback-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 4px;
        }
        .feedback-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .feedback-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .feedback-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .feedback-btn:hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="review-container">
        <header>
            <h1>ðŸ“Š Review Generated Slides</h1>
            <p class="subtitle">Evaluate and select the best presentation version</p>
        </header>

        <div id="loading" class="loading">
            <p>Loading slide versions...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="review-content" style="display: none;">
            <div class="versions-grid" id="versions-grid"></div>

            <div class="action-buttons" style="margin-top: 30px; justify-content: center;">
                <button class="btn btn-success" id="selectBtn" disabled>
                    Select Best Version
                </button>
                <button class="btn btn-primary" id="regenerateBtn">
                    Regenerate for Better Quality
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    Start Over
                </button>
            </div>

            <div class="feedback-options" style="margin-top: 20px; justify-content: center;">
                <button class="feedback-btn" onclick="showFeedbackDialog('content')">
                    Report Content Issue
                </button>
                <button class="feedback-btn" onclick="showFeedbackDialog('style')">
                    Report Style Issue
                </button>
                <button class="feedback-btn" onclick="showFeedbackDialog('information')">
                    Report Information Error
                </button>
            </div>
        </div>
    </div>

    <script>
        const submissionId = '{{ submission_id }}';
        let selectedVersion = null;
        let versionsData = [];

        // Load slides on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadSlides();
        });

        async function loadSlides() {
            try {
                const response = await fetch(`/api/slides/${submissionId}`);
                const data = await response.json();

                if (!data.success) {
                    showError(data.error || 'Failed to load slides');
                    return;
                }

                versionsData = data.versions;
                renderVersions(versionsData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('review-content').style.display = 'block';
            } catch (error) {
                showError('Error loading slides: ' + error.message);
            }
        }

        function renderVersions(versions) {
            const grid = document.getElementById('versions-grid');
            grid.innerHTML = '';

            versions.forEach(version => {
                const card = createVersionCard(version);
                grid.appendChild(card);
            });
        }

        function createVersionCard(version) {
            const card = document.createElement('div');
            card.className = 'version-card';
            card.dataset.versionNumber = version.version_number;

            const eval = version.evaluation;
            const scores = eval.scores || {};
            const overallScore = eval.overall_score || 0;

            card.innerHTML = `
                <div class="version-header">
                    <span class="version-number">Version ${version.version_number}</span>
                    <div class="scores">
                        <span class="score-badge score-clarity">Clarity: ${Math.round(scores.clarity || 0)}</span>
                        <span class="score-badge score-accuracy">Accuracy: ${Math.round(scores.accuracy || 0)}</span>
                        <span class="score-badge score-visual">Visual: ${Math.round(scores.visual_balance || 0)}</span>
                        <span class="score-badge score-audience">Audience: ${Math.round(scores.audience_fit || 0)}</span>
                    </div>
                </div>
                <div class="overall-score">${Math.round(overallScore)}/100</div>
                <div class="slides-preview">
                    ${renderSlides(version.slides)}
                </div>
                <div class="feedback-section">
                    <strong>Feedback:</strong>
                    <p style="font-size: 14px; color: #6b7280; margin: 5px 0;">
                        ${eval.feedback?.clarity || 'N/A'}
                    </p>
                </div>
            `;

            card.addEventListener('click', () => selectVersion(version.version_number, card));

            return card;
        }

        function renderSlides(slidesData) {
            let html = '';

            // Title slide
            if (slidesData.title_slide) {
                html += `
                    <div class="slide-item">
                        <div class="slide-title">${slidesData.title_slide.title || 'Title'}</div>
                        <div class="slide-content">${slidesData.title_slide.subtitle || ''}</div>
                    </div>
                `;
            }

            // Content slides
            const slides = slidesData.slides || [];
            slides.forEach(slide => {
                const content = slide.content || [];
                const contentHtml = Array.isArray(content) 
                    ? '<ul>' + content.map(item => `<li>${item}</li>`).join('') + '</ul>'
                    : `<p>${content}</p>`;

                html += `
                    <div class="slide-item">
                        <div class="slide-title">${slide.title || `Slide ${slide.slide_number || '?'}`}</div>
                        <div class="slide-content">${contentHtml}</div>
                    </div>
                `;
            });

            return html || '<p>No slides available</p>';
        }

        function selectVersion(versionNumber, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.version-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Mark as selected
            cardElement.classList.add('selected');
            selectedVersion = versionNumber;
            document.getElementById('selectBtn').disabled = false;
        }

        async function selectBestVersion() {
            if (!selectedVersion) {
                alert('Please select a version first');
                return;
            }

            const feedback = prompt('Optional: Provide feedback on the selected version:') || '';

            try {
                const response = await fetch('/api/select-slide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        version_number: selectedVersion,
                        feedback: feedback
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Slide selected successfully! Downloading presentation...');
                    window.location.href = data.download_url;
                } else {
                    alert('Error: ' + (data.error || 'Failed to select slide'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        document.getElementById('selectBtn').addEventListener('click', selectBestVersion);

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        async function regenerateForQuality() {
            if (!confirm('This will regenerate slides with improved quality. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        min_score: 75,
                        max_iterations: 3
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Regenerated slides with score ${data.score.toFixed(1)} after ${data.iterations} iterations. Reloading...`);
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to regenerate'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        document.getElementById('regenerateBtn').addEventListener('click', regenerateForQuality);

        function showFeedbackDialog(feedbackType) {
            const typeLabels = {
                'content': 'Content Issue',
                'style': 'Writing Style Issue',
                'information': 'Information Error'
            };

            const feedback = prompt(`Please describe the ${typeLabels[feedbackType]} you've identified:\n\nThis will trigger a regeneration with your feedback.`);
            
            if (feedback && feedback.trim()) {
                submitFeedback(feedbackType, feedback);
            }
        }

        async function submitFeedback(feedbackType, feedbackText) {
            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        feedback_type: feedbackType,
                        feedback: feedbackText
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message + ' Redirecting...');
                    if (data.redirect_url) {
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 1000);
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to submit feedback'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>

